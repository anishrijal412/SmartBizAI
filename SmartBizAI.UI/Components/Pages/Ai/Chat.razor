@page "/ai/chat"
@attribute [Authorize]
@inject ApiClient Api

<h1>AI Assistant</h1>

<div class="mb-3">
    <div class="border rounded p-3" style="height: 300px; overflow-y: auto;">
        @if (_messages.Count == 0)
        {
            <p class="text-muted">Ask the assistant about business insights, expenses, or invoices.</p>
        }
        else
        {
            foreach (var msg in _messages)
            {
                <div class="mb-2">
                    <strong>@msg.Role:</strong> @msg.Content
                </div>
            }
        }
    </div>
</div>

<EditForm Model="_input" OnValidSubmit="Send">
    <div class="input-group">
        <InputText class="form-control" placeholder="Type your message..." @bind-Value="_input" />
        <button class="btn btn-primary" type="submit">Send</button>
    </div>
</EditForm>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger mt-2">@_error</div>
}

@code {
    private readonly List<ChatMessage> _messages = new();
    private string _input = string.Empty;
    private string? _error;

    private async Task Send()
    {
        _error = null;
        if (string.IsNullOrWhiteSpace(_input))
        {
            return;
        }

        var userMessage = _input;
        _messages.Add(new ChatMessage("User", userMessage));
        _input = string.Empty;

        var response = await Api.SendChatAsync(new AiChatRequestDto { Message = userMessage }, CancellationToken.None);
        if (response == null)
        {
            _error = "No response from AI service.";
            return;
        }

        _messages.Add(new ChatMessage("Assistant", response.Response));
    }

    private sealed record ChatMessage(string Role, string Content);
}
